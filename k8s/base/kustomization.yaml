apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: api-template-prod

# Namespace for all resources
namespace: api-template-prod

# Auto-generate ConfigMaps from .env file
# Other ConfigMaps (app-config, postgres-config, etc.) are generated by
# k8s/scripts/deploy-config.sh from source files to work around Kustomize
# security constraints (files must be in k8s/base/ directory)
configMapGenerator:
  - name: app-env
    envs:
      - .env.k8s
    options:
      disableNameSuffixHash: true

# Common labels applied to all resources (metadata only, not selectors)
# Note: Using commonLabels adds labels to Service selectors which breaks pod matching
# Use labels: in each resource definition instead
# commonLabels:
#   app.kubernetes.io/managed-by: kustomize
#   environment: production

# Resources to deploy (in order)
resources:
  # 1. Namespace
  - namespace/namespace.yaml
  
  # 2. Storage (PVCs)
  - storage/persistentvolumeclaims.yaml
  
  # 3. ConfigMaps (auto-synced from source files by deploy-config.sh)
  # app-env is auto-generated from .env.k8s via configMapGenerator above
  - configmaps/app-config.yaml
  - configmaps/postgres-config.yaml
  - configmaps/postgres-verifier-config.yaml
  - configmaps/temporal-config.yaml
  
  # 4. Services
  - services/services.yaml
  
  # 5. Deployments
  - deployments/postgres.yaml
  - deployments/redis.yaml
  - deployments/temporal.yaml
  - deployments/temporal-web.yaml
  - deployments/app.yaml
  
  # 6. Jobs (init tasks)
  - jobs/postgres-verifier.yaml
  - jobs/temporal-schema-setup.yaml
  - jobs/temporal-namespace-init.yaml

# Image transformations (if needed in future)
# images:
#   - name: api-template-app
#     newName: your-registry.io/api-template-app
#     newTag: 1.0.0

# Configuration options
configurations: []

# Patches (if needed in future)
patches: []

# Replacements (if needed in future)
replacements: []
