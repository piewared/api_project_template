apiVersion: v1
kind: ConfigMap
metadata:
  name: temporal-config
  namespace: api-template-prod
  labels:
    app.kubernetes.io/name: temporal
    app.kubernetes.io/component: workflow-engine
data:
  schema-setup.sh: |
    #!/usr/bin/env sh
    set -euo pipefail
    
    # ---- Required env ----
    : "${TEMPORAL_DB:?missing DB (database name, e.g. temporal)}"
    : "${TEMPORAL_VIS_DB:?missing DB (database name, e.g. temporal_visibility)}"
    : "${TEMPORAL_DB_USER:?missing PG_USER (e.g. temporal_user)}"
    : "${PW_FILE:?missing PW_FILE (password file for temporal user)}"
    : "${EP:?missing EP (Postgres host, e.g. postgres)}"
    
    # Optional env
    PG_PORT="${PG_PORT:-5432}"
    PLUGIN="${PLUGIN:-postgres12}"
    
    # Read password securely from Docker secret
    PGPASSWORD="$(cat "$PW_FILE")"
    export PGPASSWORD
    
    # TLS defaults
    SSL_MODE="${SSL_MODE:-verify-ca}"
    TLS_ENABLE="${TLS_ENABLE:-true}"
    TLS_CA_FILE="${TLS_CA_FILE:-/run/secrets/ca-bundle.crt}"
    TLS_SERVER_NAME="${TLS_SERVER_NAME:-postgres}"
    
    export PGSSLMODE="${SSL_MODE:-verify-ca}"
    
    # Helper wrapper
    run_sql_tool () {
      local DB="$1"
      local action="$2"
    
      echo "Running temporal-sql-tool on DB '$DB' with action '$action'"
      echo "DB=$DB host=$EP port=$PG_PORT user=$TEMPORAL_DB_USER"
    
      temporal-sql-tool \
        --plugin "$PLUGIN" \
        --ep "$EP" -p "$PG_PORT" \
        -u "$TEMPORAL_DB_USER" -pw "$PGPASSWORD" \
        --db "$DB" \
        --tls="$TLS_ENABLE" \
        --tls-ca-file "$TLS_CA_FILE" \
        --tls-server-name "$TLS_SERVER_NAME" \
        $action
    }
    
    echo "== Temporal schema setup =="
    echo "Main schema=$TEMPORAL_DB, Visibility schema=$TEMPORAL_VIS_DB"
    
    # --- Main store ---
    echo "--> Creating/updating main store in schema: $TEMPORAL_DB"
    run_sql_tool "$TEMPORAL_DB" "setup-schema -v 0.0" || true
    run_sql_tool "$TEMPORAL_DB" "update-schema --schema-name postgresql/v12/temporal"
    
    # --- Visibility store ---
    echo "--> Creating/updating visibility store in schema: $TEMPORAL_VIS_DB"
    run_sql_tool "$TEMPORAL_VIS_DB" "setup-schema -v 0.0" || true
    run_sql_tool "$TEMPORAL_VIS_DB" "update-schema --schema-name postgresql/v12/visibility"
    
    echo "== Temporal schema setup complete =="

  entrypoint.sh: |
    #!/bin/bash
    
    # Read mounted password secret file and export as env variable
    if [ -f /run/secrets/postgres_temporal_pw ]; then
        export PW_FILE="/run/secrets/postgres_temporal_pw"
        export POSTGRES_PWD="$(cat /run/secrets/postgres_temporal_pw)"
    else
        echo "âŒ Password file not found: /run/secrets/postgres_temporal_pw" >&2
        exit 1
    fi
    
    # Now call the original entrypoint script
    exec /etc/temporal/entrypoint.sh
