apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: api-template-prod

# Namespace for all resources
namespace: api-template-prod

# Auto-generate ConfigMaps from source files
# deploy-config.sh copies source files to k8s/base/.k8s-sources/ then Kustomize generates ConfigMaps
configMapGenerator:
  # Environment variables
  - name: app-env
    envs:
      - .k8s-sources/.env.k8s
    options:
      disableNameSuffixHash: true
  
  # Application config
  - name: app-config
    files:
      - config.yaml=.k8s-sources/config.yaml.k8s
    options:
      disableNameSuffixHash: true
  
  # PostgreSQL configs
  - name: postgres-config
    files:
      - postgresql.conf=.k8s-sources/postgresql.conf.k8s
      - pg_hba.conf=.k8s-sources/pg_hba.conf.k8s
      - 01-init-app.sh=.k8s-sources/01-init-app.sh.k8s
    options:
      disableNameSuffixHash: true
  
  # PostgreSQL verifier
  - name: postgres-verifier-config
    files:
      - verify-postgres.sh=.k8s-sources/verify-postgres.sh.k8s
    options:
      disableNameSuffixHash: true

# Common labels applied to all resources (metadata only, not selectors)
# Note: Using commonLabels adds labels to Service selectors which breaks pod matching
# Use labels: in each resource definition instead
# commonLabels:
#   app.kubernetes.io/managed-by: kustomize
#   environment: production

# Resources to deploy (in order)
resources:
  # 1. Namespace
  - namespace/namespace.yaml
  
  # 2. Storage (PVCs)
  - storage/persistentvolumeclaims.yaml
  
  # 3. ConfigMaps
  # All ConfigMaps auto-generated via configMapGenerator above
  - configmaps/temporal-config.yaml
  
  # 4. Services
  - services/services.yaml
  
  # 5. Deployments
  - deployments/postgres.yaml
  - deployments/redis.yaml
  - deployments/temporal.yaml
  - deployments/temporal-web.yaml
  - deployments/app.yaml
  
  # 6. Jobs (init tasks)
  - jobs/postgres-verifier.yaml
  - jobs/temporal-schema-setup.yaml
  - jobs/temporal-namespace-init.yaml

# Image transformations (if needed in future)
# images:
#   - name: api-template-app
#     newName: your-registry.io/api-template-app
#     newTag: 1.0.0

# Configuration options
configurations: []

# Patches (if needed in future)
patches: []

# Replacements (if needed in future)
replacements: []
