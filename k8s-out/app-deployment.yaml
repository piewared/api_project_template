apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: kompose convert -f docker-compose.prod.yml -o k8s-out/
    kompose.version: 1.37.0 (fb0539e64)
  labels:
    io.kompose.service: app
  name: app
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: app
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        kompose.cmd: kompose convert -f docker-compose.prod.yml -o k8s-out/
        kompose.version: 1.37.0 (fb0539e64)
      labels:
        io.kompose.service: app
    spec:
      containers:
        - env:
            - name: APP_HOST
              value: 0.0.0.0
            - name: APP_PORT
              value: "8000"
            - name: CONTAINER_USER_GID
              value: appgroup
            - name: CONTAINER_USER_UID
              value: appuser
            - name: CREATE_ENV_VARS
              value: "true"
            - name: LOG_FORMAT
              value: json
            - name: LOG_LEVEL
              value: INFO
            - name: SECRETS_SOURCE_DIR
              value: /run/secrets
            - name: SECRETS_TARGET_DIR
              value: /app/secrets
            - name: SKIP_USER_SWITCH
              value: "false"
          envFrom:
            - configMapRef:
                name: env
          image: api-template-app:latest
          livenessProbe:
            exec:
              command:
                - python
                - -c
                - import httpx; httpx.get('http://localhost:8000/health', timeout=5)
            failureThreshold: 3
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          name: api-template-app-prod
          ports:
            - containerPort: 8000
              protocol: TCP
          resources:
            limits:
              cpu: "1"
              memory: "536870912"
            requests:
              cpu: 250m
              memory: "134217728"
          securityContext:
            capabilities:
              add:
                - CHOWN
                - DAC_OVERRIDE
                - FOWNER
                - SETUID
                - SETGID
              drop:
                - ALL
          volumeMounts:
            - mountPath: /run/secrets
              name: postgres-app-user-pw
              subPath: postgres-app-user-pw
            - mountPath: /run/secrets
              name: redis-password
              subPath: redis-password
            - mountPath: /run/secrets
              name: session-signing-secret
              subPath: session-signing-secret
            - mountPath: /run/secrets
              name: csrf-signing-secret
              subPath: csrf-signing-secret
            - mountPath: /app/config.yaml
              name: app-cm0
              readOnly: true
              subPath: config.yaml
            - mountPath: /app/logs
              name: app-logs
            - mountPath: /etc/localtime
              name: app-cm2
              readOnly: true
              subPath: localtime
            - mountPath: /tmp
              name: app-tmpfs0
      restartPolicy: Always
      volumes:
        - name: postgres-app-user-pw
          secret:
            items:
              - key: postgres-app-user-pw
                path: postgres-app-user-pw
            secretName: postgres-app-user-pw
        - name: redis-password
          secret:
            items:
              - key: redis-password
                path: redis-password
            secretName: redis-password
        - name: session-signing-secret
          secret:
            items:
              - key: session-signing-secret
                path: session-signing-secret
            secretName: session-signing-secret
        - name: csrf-signing-secret
          secret:
            items:
              - key: csrf-signing-secret
                path: csrf-signing-secret
            secretName: csrf-signing-secret
        - configMap:
            items:
              - key: config.yaml
                path: config.yaml
            name: app-cm0
          name: app-cm0
        - name: app-logs
          persistentVolumeClaim:
            claimName: app-logs
        - configMap:
            items:
              - key: localtime
                path: localtime
            name: app-cm2
          name: app-cm2
        - emptyDir:
            medium: Memory
          name: app-tmpfs0
