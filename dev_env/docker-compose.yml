version: "3.8"

services:
  keycloak:
    extends:
      file: keycloak/docker-compose.yml
      service: keycloak

  keycloak-setup:
    image: python:3.11-slim
    depends_on:
      keycloak:
        condition: service_healthy
    environment:
      - KEYCLOAK_URL=http://keycloak:8080
    volumes:
      - ../src/dev:/app/src/dev
      - ./keycloak/setup_script.py:/app/setup_script.py
    working_dir: /app
    command: >
      sh -c "
        pip install requests &&
        python setup_script.py
      "
    networks:
      - dev-network
    restart: "no"

  postgres:
    extends:
      file: postgres/docker-compose.yml
      service: postgres

  redis:
    extends:
      file: redis/docker-compose.yml
      service: redis

  temporal-postgresql:
    container_name: api-template-temporal-postgresql
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: temporal
      POSTGRES_USER: temporal
    networks:
      - dev-network
    expose:
      - 5432
    volumes:
      - temporal_postgres_data:/var/lib/postgresql/data

  temporal-server:
    container_name: api-template-temporal
    image: temporalio/auto-setup:1.28.1
    depends_on:
      - temporal-postgresql
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=temporal
      - POSTGRES_SEEDS=temporal-postgresql
      - TEMPORAL_ADDRESS=temporal-server:7233
      - TEMPORAL_CLI_ADDRESS=temporal-server:7233
    networks:
      - dev-network
    ports:
      - 7233:7233

  temporal-web:
    container_name: api-template-temporal-ui
    image: temporalio/ui:2.34.0
    depends_on:
      - temporal-server
    environment:
      - TEMPORAL_ADDRESS=temporal-server:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000
    networks:
      - dev-network
    ports:
      - 8081:8080

volumes:
  keycloak_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  temporal_postgres_data:
    driver: local
  temporal_data:
    driver: local

networks:
  dev-network:
    name: dev-network
    driver: bridge